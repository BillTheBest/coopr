<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-3']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Chef Solo Automator Plugin &mdash; Coopr 0.9.9 Documentation</title>
    
    <link rel="stylesheet" href="../../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Coopr 0.9.9 Documentation" href="../../index.html" />
    <link rel="up" title="Provisioner Plugins" href="plugins.html" />
    <link rel="next" title="Docker Automator Plugin" href="docker-automator-plugin.html" />
    <link rel="prev" title="Provisioner Plugins" href="plugins.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="docker-automator-plugin.html" title="Docker Automator Plugin"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="plugins.html" title="Provisioner Plugins"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/coopr/json-versions.js"/></script>
        <script>window.setVersion('0.9.9');</script>
       
        <li><a href="../../index.html">Coopr Documentation v0.9.9</a> &raquo;</li>
          <li><a href="index.html" >Super Admin Guide</a> &raquo;</li>
          <li><a href="plugins.html" accesskey="U">Provisioner Plugins</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <span class="target" id="plugin-reference"></span><div class="section" id="chef-solo-automator-plugin">
<span id="index-0"></span><h1>Chef Solo Automator Plugin<a class="headerlink" href="#chef-solo-automator-plugin" title="Permalink to this headline">¶</a></h1>
<p>This section describes an automator that uses chef-solo. Basic knowledge of Chef and its primitives is assumed.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Chef Solo Automator plugin, like all automator plugins, is responsible for performing the installation and
operation of services on remote hosts. The Chef Solo Automator plugin achieves this by running chef-solo on the remote host
with a custom run-list and set of JSON attributes. The attributes provided to each chef-solo run will be a combination
of cluster-wide configuration attributes, as well as service-specific attributes definable for each action. Each
chef-solo run is self-contained and intended to perform a specific task such as starting a service. This differs from
the typical usage of Chef where one builds up a large run-list managing all resources on a box in one run.</p>
<p>To illustrate this, consider the following example which shows how we can manage the apache web server on Coopr cluster
nodes using the &#8220;apache2&#8221; community cookbook. We define a Coopr service &#8220;apache-httpd&#8221; as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">{</span>
    <span class="s">&quot;dependson&quot;</span><span class="o">:</span> <span class="o">[</span>
        <span class="s">&quot;hosts&quot;</span>
    <span class="o">],</span>
    <span class="s">&quot;description&quot;</span><span class="o">:</span> <span class="s">&quot;Apache HTTP Server&quot;</span><span class="o">,</span>
    <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;apache-httpd&quot;</span><span class="o">,</span>
    <span class="s">&quot;provisioner&quot;</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">&quot;actions&quot;</span><span class="o">:</span> <span class="o">{</span>
            <span class="s">&quot;install&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;chef-solo&quot;</span>
                <span class="s">&quot;fields&quot;</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">&quot;run_list&quot;</span><span class="o">:</span> <span class="s">&quot;recipe[apache2::default]&quot;</span><span class="o">,</span>
                <span class="o">}</span>
            <span class="o">},</span>
            <span class="s">&quot;configure&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;chef-solo&quot;</span>
                <span class="s">&quot;fields&quot;</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">&quot;run_list&quot;</span><span class="o">:</span> <span class="s">&quot;recipe[apache2::default]&quot;</span><span class="o">,</span>
                <span class="o">}</span>
            <span class="o">},</span>
            <span class="s">&quot;start&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;chef-solo&quot;</span>
                <span class="s">&quot;fields&quot;</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">&quot;json_attributes&quot;</span><span class="o">:</span> <span class="s">&quot;{\&quot;coopr\&quot;: { \&quot;node\&quot;: { \&quot;services\&quot;: { \&quot;apache2\&quot;: \&quot;start\&quot; } } } }&quot;</span><span class="o">,</span>
                    <span class="s">&quot;run_list&quot;</span><span class="o">:</span> <span class="s">&quot;recipe[apache2::default],recipe[coopr_service_manager::default]&quot;</span><span class="o">,</span>
                <span class="o">}</span>
            <span class="o">},</span>
            <span class="s">&quot;stop&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;chef-solo&quot;</span>
                <span class="s">&quot;fields&quot;</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">&quot;json_attributes&quot;</span><span class="o">:</span> <span class="s">&quot;{\&quot;coopr\&quot;: { \&quot;node\&quot;: { \&quot;services\&quot;: { \&quot;apache2\&quot;: \&quot;stop\&quot; } } } }&quot;</span><span class="o">,</span>
                    <span class="s">&quot;run_list&quot;</span><span class="o">:</span> <span class="s">&quot;recipe[apache2::default],recipe[coopr_service_manager::default]&quot;</span><span class="o">,</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>For each action, we define the <tt class="docutils literal"><span class="pre">type</span></tt>, and the custom fields <tt class="docutils literal"><span class="pre">run_list</span></tt> and <tt class="docutils literal"><span class="pre">json_attributes</span></tt>. (defaults to empty string if not specified). The <tt class="docutils literal"><span class="pre">type</span></tt>
field indicates to the provisioner to use the Chef Solo Automator plugin to manage this action. The <tt class="docutils literal"><span class="pre">run_list</span></tt> field specifies
the run-list to use. The <tt class="docutils literal"><span class="pre">json_attributes</span></tt> field is any additional JSON data we wish to include in the Chef run (more on this
later). When the Chef Solo Automator plugin executes any of these actions for the apache-httpd service, it performs
the following actions:</p>
<blockquote>
<div><ol class="arabic simple">
<li>generate a task-specific JSON file containing any attributes defined in the json_attributes field, as well as base cluster attributes defined elsewhere in Coopr.</li>
<li>invoke chef-solo using the <tt class="docutils literal"><span class="pre">run_list</span></tt> field as the run-list as follows:  <tt class="docutils literal"><span class="pre">chef-solo</span> <span class="pre">-o</span> <span class="pre">[run_list]</span> <span class="pre">-j</span> <span class="pre">[task-specific</span> <span class="pre">json]</span></tt></li>
</ol>
</div></blockquote>
<p>In this example, to execute an &#8220;install&#8221; task for the apache-httpd service, the provisioner will simply run the default
recipe from the apache2 cookbook as a single chef-solo run. No additional JSON attributes are provided beyond the base
cluster configuration attributes.</p>
<p>For a &#8220;configure&#8221; task, the provisioner will also run the default recipe from the apache2 cookbook. For this community
cookbook, the installation and configuration are done in the same recipe, which is common but not always the case. So
one may wonder why we need both &#8216;install&#8217; and &#8216;configure&#8217; when they perform identical actions. It is best practice to
keep them both, since configure may be run many times throughout the lifecycle of the cluster, and install is needed
to satisfy dependencies.</p>
<p>The &#8220;start&#8221; and &#8220;stop&#8221; tasks introduce a couple of features. They make use of the <tt class="docutils literal"><span class="pre">json_attributes</span></tt> field to specify custom JSON
attributes. Note that the format is an escaped JSON string. The <tt class="docutils literal"><span class="pre">run_list</span></tt> field also contains an additional recipe,
<tt class="docutils literal"><span class="pre">coopr_service_manager::default</span></tt>. More on this later, but essentially this is a helper cookbook that can operate on
any Chef service resource. It looks for any service names listed in node[&#8216;coopr&#8217;][&#8216;node&#8217;][&#8216;services&#8217;], finds the
corresponding Chef service resource, and invokes the specified action.</p>
</div>
<div class="section" id="json-attributes">
<h2>JSON Attributes<a class="headerlink" href="#json-attributes" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Coopr maintains significant JSON data for a cluster, and makes it available for each task. This JSON data includes:</dt>
<dd><ul class="first last simple">
<li>cluster-wide configuration defined in cluster templates (Catalog -&gt; cluster template -&gt; defaults -&gt; config)</li>
<li>node data for each node of the cluster: hostname, ip, etc</li>
<li>service data, specified in the actions for each service</li>
</ul>
</dd>
</dl>
<p>The Chef Solo Automator plugin automatically merges this data into a single JSON file, which is then passed to chef-solo via
the <tt class="docutils literal"><span class="pre">--json-attributes</span> <span class="pre">argument</span></tt>. Any custom cookbooks that want to make use of this Coopr data need to be familiar
with the JSON layout of the Coopr data. In brief, cluster-wide configuration defined in cluster templates and
service-level action data are deep-merged together, with service-level action data taking precedence. This data is
preserved at the top level, and also merged in under <tt class="docutils literal"><span class="pre">coopr/*</span></tt>. For example:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">{</span>
    <span class="c1">// cluster config attributes defined in clustertemplates are preserved here at top-level</span>
    <span class="c1">// service-level action data string converted to json and deep-merged here at top-level</span>
    <span class="s">&quot;coopr&quot;</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">&quot;clusterId&quot;</span><span class="o">:</span> <span class="s">&quot;00000001&quot;</span><span class="o">,</span>
        <span class="s">&quot;cluster&quot;</span><span class="o">:</span> <span class="o">{</span>
            <span class="c1">//cluster config here as well</span>
            <span class="s">&quot;nodes&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="c1">// node data</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="s">&quot;services&quot;</span><span class="o">:</span> <span class="o">[</span>
          <span class="c1">// list of coopr services on this node</span>
        <span class="o">]</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<dl class="docutils">
<dt>Consider the following rules of thumb:</dt>
<dd><ul class="first last simple">
<li>When using community cookbooks, attributes can be specified in Coopr templates exactly as the cookbook expects (at the top level). If separate services require the same recipe with different attributes, these attributes can be specified in the service <tt class="docutils literal"><span class="pre">json_attributes</span></tt> field</li>
<li>When writing cookbooks specifically utilizing Coopr metadata (cluster node data for example), recipes can access the metadata at <tt class="docutils literal"><span class="pre">node['coopr']['cluster']...</span></tt></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="bootstrap">
<h2>Bootstrap<a class="headerlink" href="#bootstrap" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Each Coopr Automator plugin is responsible for implementing a bootstrap method in which it performs any action it needs to be able to carry out further tasks. The Chef Solo Automator plugin performs the following actions for a bootstrap task:</dt>
<dd><ol class="first last arabic">
<li><dl class="first docutils">
<dt>Bundle its local copy of the cookbooks/roles/data_bags directories into three tarballs, <tt class="docutils literal"><span class="pre">cookbooks.tar.gz</span></tt>, <tt class="docutils literal"><span class="pre">roles.tar.gz</span></tt>, <tt class="docutils literal"><span class="pre">data_bags.tar.gz</span></tt></dt>
<dd><ul class="first last simple">
<li>This only happens if prior versions of the tarballs were not created in the past 10 minutes</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Logs into the remote box and installs chef in one of three ways in this order:</dt>
<dd><ol class="first last loweralpha simple">
<li>via <tt class="docutils literal"><span class="pre">yum</span> <span class="pre">install</span></tt> to leverage any internal yum repositories preconfigured on the remote host</li>
<li>via <tt class="docutils literal"><span class="pre">apt-get</span> <span class="pre">install</span></tt> to leverage any internal apt repositories preconfigured on the remote host</li>
<li>via the Opscode Omnibus installer (<tt class="docutils literal"><span class="pre">curl</span> <span class="pre">-L</span> <span class="pre">https://www.opscode.com/chef/install.sh</span> <span class="pre">|</span> <span class="pre">bash</span></tt>). This requires internet access on the remote host</li>
</ol>
</dd>
</dl>
</li>
<li><p class="first">Creates the remote coopr cache directory <tt class="docutils literal"><span class="pre">/var/cache/coopr</span></tt></p>
</li>
<li><p class="first">SCPs the local tarballs to the remote Coopr cache directory</p>
</li>
<li><p class="first">Extracts the tarballs on the remote host to the default chef directory <tt class="docutils literal"><span class="pre">/var/chef</span></tt></p>
</li>
</ol>
</dd>
<dt>The most important things to note:</dt>
<dd><ul class="first last simple">
<li>Upon adding any new cookbooks, roles, or data_bags to the local directories, the tarballs will be regenerated within 10 minutes and used by all running provisioners.</li>
<li>Internet access may be needed to install chef unless steps are taken to provide chef in alternate ways.  Most of the bundled community cookbooks require internet access as well.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="internet-access">
<h2>Internet Access<a class="headerlink" href="#internet-access" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Coopr and the Chef Solo Automator plugin can still be used in an environment without Internet access, with some restrictions:</dt>
<dd><ol class="first last arabic simple">
<li>Chef must be pre-installed on the target hosts&#8217; images, or installable via a pre-configured Yum or Apt repository</li>
<li>The bundled community cookbooks cannot be used.  Note the provided <a class="reference internal" href="#helper-cookbooks">Helper Cookbooks</a> do not require internet access</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="adding-your-own-cookbooks">
<h2>Adding Your Own Cookbooks<a class="headerlink" href="#adding-your-own-cookbooks" title="Permalink to this headline">¶</a></h2>
<p><strong>Cookbook requirements</strong></p>
<p>Since the Chef Solo Automator plugin is implemented using chef-solo, the following restrictions apply:</p>
<blockquote>
<div><ul class="simple">
<li>No Chef search capability</li>
<li>No persistent attributes</li>
</ul>
</div></blockquote>
<p>Cookbooks should be fully attribute-driven. At this time the Chef Solo Automator does not support the chef-solo &#8220;environment&#8221; primitive.
Attributes normally specified in an environment can instead be populated in Coopr primitives such as cluster templates or service action data.</p>
<p><strong>Cookbooks as plugin resources</strong></p>
<p>The Chef Solo Automator utilizes the <a class="reference internal" href="../admin/plugin-resources.html"><em>Plugin Resources</em></a> capability of Coopr in order to manage cookbooks, data bags, and roles.  Each of these Chef primitives can be uploaded to the Coopr server individually as resources.  Refer to the <a class="reference internal" href="../admin/plugin-resources.html"><em>Plugin Resources Guide</em></a> for more details on plugin resource management.</p>
<p>Examples:</p>
<pre class="literal-block">
/opt/coopr/provisioner/embedded/bin/ruby /opt/coopr/provisioner/bin/data-uploader.rb -u http://localhost:55054 -t superadmin -U admin sync ./my/local/cookbooks/myapp automatortypes/chef-solo/cookbooks/myapp

/opt/coopr/provisioner/embedded/bin/ruby /opt/coopr/provisioner/bin/data-uploader.rb -u http://localhost:55054 -t superadmin -U admin sync ./my/local/data_bags/mydata_bag automatortypes/chef-solo/data_bags/my_data_bag

/opt/coopr/provisioner/embedded/bin/ruby /opt/coopr/provisioner/bin/data-uploader.rb -u http://localhost:55054 -t superadmin -U admin sync ./my/local/roles/my_role.rb automatortypes/chef-solo/cookbooks/my_role.rb
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are uploading an archive of a directory, the top level directory of your unpacked archive must be named exactly the same as your resource name. For example, if you are uploading an archive of a directory named &#8216;mycookbook&#8217;, you <em>must</em> name your resource &#8216;mycookbook&#8217; in order for it to be used correctly. This issue will be fixed in the next release.</p>
</div>
<p><strong>Invoking your Cookbook</strong></p>
<p>In order to actually invoke your cookbook or role as part of a cluster provision, you will need to define a Coopr service
definition with the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li>Category: any action (install, configure, start, stop, etc)</li>
<li>Type: chef-solo</li>
<li>run_list: a run-list containing your cookbook&#8217;s recipe(s) or roles. If your recipe depends on resources defined in other cookbooks which aren&#8217;t declared dependencies in your cookbook&#8217;s metadata, make sure to also add them to the run-list.</li>
<li>json_attributes: (optional), any additional custom attributes you want to specify, unique to this action</li>
</ul>
</div></blockquote>
<p>Then simply add your service to a cluster template.</p>
</div>
<div class="section" id="helper-cookbooks">
<h2>Helper Cookbooks<a class="headerlink" href="#helper-cookbooks" title="Permalink to this headline">¶</a></h2>
<p>Coopr ships with several helper cookbooks. These are provided as convenience and are completely optional. This section provides a brief overview of each.</p>
<div class="section" id="coopr-base">
<h3><strong>coopr_base</strong><a class="headerlink" href="#coopr-base" title="Permalink to this headline">¶</a></h3>
<p>This is a convenience cookbook which is intended to provide base functionality for all hosts provisioned by Coopr. The default <tt class="docutils literal"><span class="pre">base</span></tt> service definition runs
the <tt class="docutils literal"><span class="pre">coopr_base::default</span></tt> recipe, which may include additional helper cookbooks. It currently does the following:</p>
<blockquote>
<div><ul class="simple">
<li>run <tt class="docutils literal"><span class="pre">apt-get</span> <span class="pre">update</span></tt> (on Ubuntu hosts)</li>
<li>optionally configure the Yum <tt class="docutils literal"><span class="pre">epel</span></tt> repository (on Rhel hosts)</li>
<li>optionally include <tt class="docutils literal"><span class="pre">coopr_dns::default</span></tt> (discussed below)</li>
<li>optionally include <tt class="docutils literal"><span class="pre">coopr_firewall::default</span></tt> (discussed below)</li>
<li>optionally include <tt class="docutils literal"><span class="pre">coopr_hosts::default</span></tt> (discussed below)</li>
<li>optionally include <tt class="docutils literal"><span class="pre">coopr_packages::default</span></tt> (discussed below)</li>
<li>include <tt class="docutils literal"><span class="pre">ulimit::default</span></tt> to enable user-defined ulimits</li>
<li>optionally runs the <tt class="docutils literal"><span class="pre">users</span></tt> and <tt class="docutils literal"><span class="pre">sudo</span></tt> cookbooks to add any users if a <tt class="docutils literal"><span class="pre">users</span></tt> data_bag resource is present</li>
</ul>
</div></blockquote>
<p>To disable the configuring of the Yum <tt class="docutils literal"><span class="pre">epel</span></tt> repository on Rhel hosts, set the <tt class="docutils literal"><span class="pre">node['base']['use_epel']</span></tt> attribute to <tt class="docutils literal"><span class="pre">false</span></tt>.</p>
<p>To disable the inclusion of the remaining helper cookbooks, set the following attributes. Note, though, that these cookbooks are designed to not take action unless
specific attributes are added to your Coopr templates:</p>
<div class="highlight-java"><div class="highlight"><pre>node[&#39;base&#39;][&#39;no_dns&#39;] = &#39;true&#39;
node[&#39;base&#39;][&#39;no_firewall&#39;] = &#39;true&#39;
node[&#39;base&#39;][&#39;no_hosts&#39;] = &#39;true&#39;
node[&#39;base&#39;][&#39;no_packages&#39;] = &#39;true&#39;
</pre></div>
</div>
<p class="rubric">User Management</p>
<p>The <tt class="docutils literal"><span class="pre">coopr_base</span></tt> cookbook provides a simple method for user management, utilizing the Chef community <a class="reference external" href="https://supermarket.chef.io/cookbooks/users">users</a> and
<a class="reference external" href="https://supermarket.chef.io/cookbooks/sudo">sudo</a> cookbooks.  To take advantage of this, simply upload a data_bag resource named <tt class="docutils literal"><span class="pre">users</span></tt> to the Coopr
Server.  As with cookbooks, you can use the data-uploader utility to do this, for example:</p>
<pre class="literal-block">
/opt/coopr/provisioner/embedded/bin/ruby /opt/coopr/provisioner/bin/data-uploader.rb -u http://localhost:55054 -t superadmin -U admin sync ./my/local/data_bags/users automatortypes/chef-solo/data_bags/users
</pre>
<p>where <tt class="docutils literal"><span class="pre">./my/local/data_bags/users</span></tt> is the data_bag to be used by the <tt class="docutils literal"><span class="pre">users</span></tt> cookbook. It should be a directory containing data_bag_items (JSON files) of the form:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">{</span>
    <span class="s">&quot;id&quot;</span><span class="o">:</span> <span class="s">&quot;bob&quot;</span><span class="o">,</span>
    <span class="s">&quot;Full Name&quot;</span><span class="o">:</span> <span class="s">&quot;Bob User&quot;</span><span class="o">,</span>
    <span class="s">&quot;groups&quot;</span><span class="o">:</span> <span class="o">[</span> <span class="s">&quot;sysadmin&quot;</span> <span class="o">],</span>
    <span class="s">&quot;shell&quot;</span><span class="o">:</span> <span class="s">&quot;\/bin\/bash&quot;</span><span class="o">,</span>
    <span class="s">&quot;ssh_keys&quot;</span><span class="o">:</span> <span class="s">&quot;ssh-rsa ...&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>If no <tt class="docutils literal"><span class="pre">users</span></tt> data_bag resource is present, no action is taken.  To explicitly disable this functionality, simply set the <tt class="docutils literal"><span class="pre">node['base']['no_users']</span></tt> attribute to <tt class="docutils literal"><span class="pre">true</span></tt></p>
</div>
<div class="section" id="coopr-dns">
<h3><strong>coopr_dns</strong><a class="headerlink" href="#coopr-dns" title="Permalink to this headline">¶</a></h3>
<p>This cookbook provides a hook to run any user-specific DNS cookbooks.  Currently, the DNSimple provider is included as a reference. To use, set the following
attributes in the included <tt class="docutils literal"><span class="pre">base</span></tt> service&#8217;s <tt class="docutils literal"><span class="pre">install</span></tt> action JSON attributes field:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">{</span>
    <span class="s">&quot;coopr_dns&quot;</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">&quot;provider&quot;</span><span class="o">:</span> <span class="s">&quot;dnsimple&quot;</span><span class="o">,</span>
        <span class="s">&quot;subdomain_whitelist&quot;</span><span class="o">:</span> <span class="o">[</span>
            <span class="s">&quot;subdomain1.example.com&quot;</span><span class="o">,</span>
            <span class="s">&quot;subdomain2.example.com&quot;</span>
        <span class="o">]</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">provider</span></tt> attribute is simply the name of a recipe that must be implemented.  The <tt class="docutils literal"><span class="pre">subdomain_whitelist</span></tt> is an optional safety mechanism to only allow
DNS records to be created for certain domains.  In this example, as part of the <tt class="docutils literal"><span class="pre">base</span></tt> service the <tt class="docutils literal"><span class="pre">coopr_dns::dnsimple</span></tt> recipe will be run, which includes
DNSimple&#8217;s cookbook and its LWRPs to create &#8220;A&#8221; records for each cluster host.</p>
</div>
<div class="section" id="coopr-hosts">
<h3><strong>coopr_hosts</strong><a class="headerlink" href="#coopr-hosts" title="Permalink to this headline">¶</a></h3>
<p>This simple cookbook&#8217;s only purpose is to populate <tt class="docutils literal"><span class="pre">/etc/hosts</span></tt> with the hostnames and IP addresses of the cluster.
It achieves this by accessing the <tt class="docutils literal"><span class="pre">coopr-populated</span></tt> attributes at <tt class="docutils literal"><span class="pre">node['coopr']['cluster']['nodes']</span></tt> to get a list of
all the nodes in the cluster. It then simply utilizes the community &#8220;hostsfile&#8221; cookbook&#8217;s LWRP to write entries for
each node.</p>
<p>The example coopr service definition invoking this cookbook is called &#8220;base&#8221;. It simply sets up a &#8220;configure&#8221; service
action of type &#8220;chef-solo&#8221; and run_list <tt class="docutils literal"><span class="pre">recipe[coopr_base::default]</span></tt> (which includes <tt class="docutils literal"><span class="pre">recipe[coopr_hosts::default]</span></tt>).
Note that the community &#8220;hostsfile&#8221; cookbook is not needed in the run-list since it is declared in coopr_hosts&#8217;s metadata.</p>
<p>By default, it will create an <tt class="docutils literal"><span class="pre">/etc/hosts</span></tt> entry for each node of the cluster, using its private <tt class="docutils literal"><span class="pre">bind_v4</span></tt> IP.  It is possible to modify this behavior
using the <tt class="docutils literal"><span class="pre">node['coopr_hosts']['address_types']</span></tt> attribute array. See <a class="reference internal" href="../admin/macros.html"><em>Macros</em></a> for more information on the available address types.</p>
</div>
<div class="section" id="coopr-service-manager">
<h3><strong>coopr_service_manager</strong><a class="headerlink" href="#coopr-service-manager" title="Permalink to this headline">¶</a></h3>
<p>This cookbook comes in handy as a simple way to isolate the starting and stopping of various services within your
cluster. It allows you to simply specify the name of a Chef service resource and an action within a Coopr service
definition. When run, it will simply lookup the Chef service resource of the given name, regardless of which cookbook
it is defined in, and run the given action. In the apache-httpd service definition example above, it is simply included
in the run-list to start or stop the apache2 service defined in the apache2 community cookbook.  Just set the following
attribute to &#8220;start&#8221; or &#8220;stop&#8221;:</p>
<div class="highlight-java"><div class="highlight"><pre>node[&#39;coopr&#39;][&#39;node&#39;][&#39;services&#39;][&#39;apache2&#39;] = &quot;start&quot;
</pre></div>
</div>
</div>
<div class="section" id="coopr-firewall">
<h3><strong>coopr_firewall</strong><a class="headerlink" href="#coopr-firewall" title="Permalink to this headline">¶</a></h3>
<p>This cookbook is a simple iptables firewall manager, with the added functionality of automatically whitelisting all
nodes in a cluster. To use, simply set any of the following attributes:</p>
<div class="highlight-java"><div class="highlight"><pre>node[&#39;coopr_firewall&#39;][&#39;INPUT_policy&#39;]  = (string)
node[&#39;coopr_firewall&#39;][&#39;FORWARD_policy&#39;] = (string)
node[&#39;coopr_firewall&#39;][&#39;OUTPUT_policy&#39;] = (string)
node[&#39;coopr_firewall&#39;][&#39;notrack_ports&#39;] = [ array ]
node[&#39;coopr_firewall&#39;][&#39;open_tcp_ports&#39;] = [ array ]
node[&#39;coopr_firewall&#39;][&#39;open_udp_ports&#39;] = [ array ]
</pre></div>
</div>
<p>If this recipe is included in the run-list and no attributes specified, the default behavior is to disable the firewall.</p>
</div>
<div class="section" id="coopr-packages">
<h3><strong>coopr_packages</strong><a class="headerlink" href="#coopr-packages" title="Permalink to this headline">¶</a></h3>
<p>This cookbook provides a convenient way to install, upgrade, or remove any number of Yum or Apt packages as part of your <tt class="docutils literal"><span class="pre">base</span></tt> service.  Simply populate
any of the following (default) attributes:</p>
<div class="highlight-java"><div class="highlight"><pre>node[&#39;coopr_packages&#39;][&#39;debian&#39;][&#39;install&#39;] = []
node[&#39;coopr_packages&#39;][&#39;debian&#39;][&#39;upgrade&#39;] = []
node[&#39;coopr_packages&#39;][&#39;debian&#39;][&#39;remove&#39;] = []
node[&#39;coopr_packages&#39;][&#39;rhel&#39;][&#39;install&#39;] = []
node[&#39;coopr_packages&#39;][&#39;rhel&#39;][&#39;upgrade&#39;] = []
node[&#39;coopr_packages&#39;][&#39;rhel&#39;][&#39;remove&#39;] = [&#39;yum-cron&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Coopr is designed to use attribute-driven cookbooks. All user-defined attributes are specified in Coopr primitives. Recipes that use Chef server capabilities like discovery and such do not operate well with Coopr.</li>
<li>Separate the install, configuration, initialization, starting/stopping, and deletion logic of your cookbooks into granular recipes. This way Coopr services can often be defined with a 1:1 mapping to recipes. Remember that Coopr will need to install, configure, initialize, start, stop, and remove your services, each independently through a combination of run-list and attributes.</li>
<li>Use wrapper cookbooks in order to customize community cookbooks to suit your needs.</li>
<li>Remember to declare cookbook dependencies in metadata.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--
  Copyright © 2014-2015 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->


    
<div aria-label="globaltoc links">
<h3 class="pagenavtitle"><a href="../../index.html"> Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Super Admin Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tenants.html">Tenant Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="callbacks.html">Cluster Callbacks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="plugins.html">Provisioner Plugins</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plugins.html#types-of-plugins">Types of Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#task-types">Task Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#writing-a-plugin">Writing a Plugin</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="plugins.html#included-plugins">Included Plugins</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="">Chef Solo Automator Plugin</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l5"><a class="reference internal" href="#json-attributes">JSON Attributes</a></li>
<li class="toctree-l5"><a class="reference internal" href="#bootstrap">Bootstrap</a></li>
<li class="toctree-l5"><a class="reference internal" href="#internet-access">Internet Access</a></li>
<li class="toctree-l5"><a class="reference internal" href="#adding-your-own-cookbooks">Adding Your Own Cookbooks</a></li>
<li class="toctree-l5"><a class="reference internal" href="#helper-cookbooks">Helper Cookbooks</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#coopr-base"><strong>coopr_base</strong></a></li>
<li class="toctree-l6"><a class="reference internal" href="#coopr-dns"><strong>coopr_dns</strong></a></li>
<li class="toctree-l6"><a class="reference internal" href="#coopr-hosts"><strong>coopr_hosts</strong></a></li>
<li class="toctree-l6"><a class="reference internal" href="#coopr-service-manager"><strong>coopr_service_manager</strong></a></li>
<li class="toctree-l6"><a class="reference internal" href="#coopr-firewall"><strong>coopr_firewall</strong></a></li>
<li class="toctree-l6"><a class="reference internal" href="#coopr-packages"><strong>coopr_packages</strong></a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="docker-automator-plugin.html">Docker Automator Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="shell-automator-plugin.html">Shell Automator Plugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#resource-types">Resource types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring and Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bcp/index.html">Business Continuity Plan (BCP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest/index.html">Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javadocs/index.html">Javadocs</a></li>
</ul>

</nav>
</div>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="plugins.html"
                        title="Previous Chapter">Provisioner Plugins</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="docker-automator-plugin.html"
                        title="Next Chapter">Docker Automator Plugin</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/coopr/0.9.9/coopr-docs-0.9.9-web.zip"
            rel="nofollow">Zip Archive of Coopr Documentation</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Provisioner Plugins" href="plugins.html" />Provisioner Plugins</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        Copyright &copy; 2014-2015 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Docker Automator Plugin" href="docker-automator-plugin.html" />Docker Automator Plugin</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-3']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Shell Automator Plugin &mdash; Coopr 0.9.8 Beta Documentation</title>
    
    <link rel="stylesheet" href="../../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.8 Beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Coopr 0.9.8 Beta Documentation" href="../../index.html" />
    <link rel="up" title="Provisioner Plugins" href="plugins.html" />
    <link rel="next" title="Monitoring and Metrics" href="monitoring.html" />
    <link rel="prev" title="Chef Solo Automator Plugin" href="chef-solo-automator-plugin.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="monitoring.html" title="Monitoring and Metrics"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="chef-solo-automator-plugin.html" title="Chef Solo Automator Plugin"
             accesskey="P">Previous</a> |</li>
        <li><a href="../../index.html">Coopr 0.9.8 Beta Documentation</a> &raquo;</li>
          <li><a href="index.html" >Super Admin Guide</a> &raquo;</li>
          <li><a href="plugins.html" accesskey="U">Provisioner Plugins</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <span class="target" id="plugin-reference"></span><div class="section" id="shell-automator-plugin">
<span id="index-0"></span><h1>Shell Automator Plugin<a class="headerlink" href="#shell-automator-plugin" title="Permalink to this headline">¶</a></h1>
<p>This section describes an automator that uses shell commands and custom scripts.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Shell Automator plugin, like all automator plugins, is responsible for performing the installation and operation
of services on remote hosts.  The Shell Automator plugin provides a simple way to execute shell commands and custom
shell scripts on remote hosts.  Scripts are maintained and stored locally by the provisioner, transferred to the
remote host, and run remotely.  Coopr also provides some additional data and utilities for extracting cluster metadata.</p>
<p>As an example, consider the following Coopr service definition:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">{</span>
    <span class="s">&quot;description&quot;</span><span class="o">:</span> <span class="s">&quot;Bootstrap a chef-client to My Chef server&quot;</span><span class="o">,</span>
    <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;cask-chef-bootstrap&quot;</span><span class="o">,</span>
    <span class="s">&quot;provisioner&quot;</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">&quot;actions&quot;</span><span class="o">:</span> <span class="o">{</span>
            <span class="s">&quot;install&quot;</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">&quot;type&quot;</span><span class="o">:</span> <span class="s">&quot;shell&quot;</span><span class="o">,</span>
                <span class="s">&quot;fields&quot;</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">&quot;script&quot;</span><span class="o">:</span> <span class="s">&quot;chef_client_bootstrap.sh&quot;</span><span class="o">,</span>
                    <span class="s">&quot;args&quot;</span><span class="o">:</span> <span class="s">&quot;https://mychefserver:443 \&quot;role[base]\&quot;&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This defines a service named &#8220;cask-chef-bootstrap&#8221; which has one defined action for &#8220;install&#8221;.  When the
install action is invoked for this service, the <tt class="docutils literal"><span class="pre">type</span></tt> field indicates to the provisioner to use the Shell Automator
plugin to manage this action.  The Shell Automator defines two custom fields: a required <tt class="docutils literal"><span class="pre">script</span></tt> and optional
<tt class="docutils literal"><span class="pre">args</span></tt>.  The <tt class="docutils literal"><span class="pre">script</span></tt> field can be a standard shell command, or a custom script.  Note that <tt class="docutils literal"><span class="pre">script</span></tt> can either
be a full path to a known executable, or a relative path to a script bundled with the Shell Automator plugin (more on
this below).  The <tt class="docutils literal"><span class="pre">args</span></tt> field is optional.  In this example, when the install action is invoked for this
service, the Shell automator will first ensure this script is transferred to the remote host(s), then effectively
invoke the following command on them:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">chef_client_bootstrap</span><span class="o">.</span><span class="na">sh</span> <span class="nl">https:</span><span class="c1">//mychefserver:443 &quot;role[base]&quot;</span>
</pre></div>
</div>
<p>Note that this example is a real script included with the Shell Automator, which can be used to bootstrap a Coopr host to an existing Chef server!</p>
</div>
<div class="section" id="how-it-works">
<h2>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>A more in-depth look at Shell Automator:</dt>
<dd><ol class="first last arabic">
<li><p class="first">The source of truth for any custom scripts is the local plugin directory on the provisioner host.  For example using the default packages: <tt class="docutils literal"><span class="pre">/opt/coopr/provisioner/daemon/plugins/automators/shell_automator/scripts</span></tt>.</p>
</li>
<li><dl class="first docutils">
<dt>During the &#8220;bootstrap&#8221; action:</dt>
<dd><ol class="first last loweralpha simple">
<li>These scripts are bundled and scp&#8217;d to the remote host</li>
<li>The scripts are extracted on the remote host, by default to <tt class="docutils literal"><span class="pre">/var/cache/coopr/scripts</span></tt></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>When a defined shell service action runs (ie, install, configure, start, etc):</dt>
<dd><ol class="first last loweralpha">
<li><p class="first">The Shell Automator first generates a copy of the current task&#8217;s JSON data</p>
</li>
<li><p class="first">This task json data is scp&#8217;d to the remote host, where it can be referenced by the executed script</p>
</li>
<li><dl class="first docutils">
<dt>The Shell Automator invokes a command on the remote host which</dt>
<dd><ol class="first last lowerroman simple">
<li>Sets the current working directory to the scripts directory</li>
<li>Adds the scripts directory to the $PATH</li>
<li>Invokes a &#8220;hidden&#8221; wrapper script, which runs the defined script with the defined args.  The purpose of the wrapper script is to provide some useful utilities (see JSON lookup below)</li>
</ol>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="bootstrap">
<h2>Bootstrap<a class="headerlink" href="#bootstrap" title="Permalink to this headline">¶</a></h2>
<p>Each Coopr Automator plugin is responsible for implementing a bootstrap method in which it performs any actions it needs
to be able to carry out further tasks. The Shell Automator plugin performs the following actions for a bootstrap task:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Bundle its local copy of the scripts directory into a tarball, <tt class="docutils literal"><span class="pre">scripts.tar.gz</span></tt>, unless the tarball exists already and was created in the last 10 minutes.</li>
<li>Logs into the remote box and creates the Coopr cache diretory <tt class="docutils literal"><span class="pre">/var/cache/coopr</span></tt>.</li>
<li>SCP the local tarball to the remote Coopr cache directory.</li>
<li>Extracts the tarball on the remote host in the coopr cache directory, creating <tt class="docutils literal"><span class="pre">/var/cache/coopr/scripts</span></tt>.</li>
</ol>
</div></blockquote>
<p>The most important thing to note is that upon adding any new script to the local directory, the tarball will be
regenerated within 10 minutes and used by all running provisioners.</p>
</div>
<div class="section" id="json-lookup">
<h2>JSON Lookup<a class="headerlink" href="#json-lookup" title="Permalink to this headline">¶</a></h2>
<p>The Shell Automator has limited support for looking up values in the Coopr cluster metadata.  This should be considered
an advanced feature and used with caution!  The current implementation uses json.sh: <a class="reference external" href="https://github.com/rcrowley/json.sh">https://github.com/rcrowley/json.sh</a>.</p>
<p>For every invocation of a user&#8217;s defined script, the Shell Automator actually invokes a wrapper script which then
sources the user&#8217;s script.  The wrapper script provides the <tt class="docutils literal"><span class="pre">coopr_lookup_key</span></tt> function.  This function takes a
&#8216;/&#8217;-delimited key as an argument, for example <tt class="docutils literal"><span class="pre">config/automators</span></tt>.  It will look up the corresponding key in the
task json, and return the value.  If the value is an array, it will return the values space-delimited.  Example usage:</p>
<div class="highlight-java"><div class="highlight"><pre>task_id=`coopr_lookup_key taskId 2&gt;&amp;1`
echo &quot;json root key \&quot;taskId\&quot; has value: $task_id&quot;
automators=`coopr_lookup_key config/automators 2&gt;&amp;1`
echo &quot;automators in use for this cluster:&quot;
for i in $automators ; do echo $i ; done
</pre></div>
</div>
<p>The wrapper script and implementation of coopr_lookup_key is in the <tt class="docutils literal"><span class="pre">scripts/.lib</span></tt> directory.  Those interested in
this functionality should familiarize themselves with the code and be aware of the potential pitfalls (duplicate
key names, etc).</p>
</div>
<div class="section" id="adding-your-own-scripts">
<h2>Adding your own Scripts<a class="headerlink" href="#adding-your-own-scripts" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic simple">
<li>add your script to the <tt class="docutils literal"><span class="pre">$COOPR_HOME/provisioner/daemon/plugins/automators/shell_automator/scripts</span></tt> directory.</li>
<li>add/edit a service definition with an action of type &#8220;shell&#8221;</li>
<li>specify the command to run, optional args, and during which stage it should run.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>Shell Automator can be very handy for edge cases where the standard automator plugins and configuration management falls short.  As illustration, with the included chef_client_bootstrap.sh utility, it is possible to provision a cluster using one set of cookbooks, and then hand it off to a separate chef-server.</li>
<li>Shell Automator has the capability to run user-defined commands as root.  Administrators should take precautions.</li>
<li>Understand the risks and pitfalls of the JSON lookup before depending on it.</li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!--
  ~ Copyright 2014 Cask Data, Inc.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License"); you may not
  ~ use this file except in compliance with the License. You may obtain a copy of
  ~ the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  ~ WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing permissions and limitations under
  ~ the License.
  -->

<h3><a href="../../index.html">Table of Contents</a></h3>
<nav>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Super Admin Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="tenants.html">Tenant Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="callbacks.html">Cluster Callbacks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="plugins.html">Provisioner Plugins</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plugins.html#types-of-plugins">Types of Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#task-types">Task Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#writing-a-plugin">Writing a Plugin</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="plugins.html#included-plugins">Included Plugins</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="chef-solo-automator-plugin.html">Chef Solo Automator Plugin</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="">Shell Automator Plugin</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l5"><a class="reference internal" href="#how-it-works">How it Works</a></li>
<li class="toctree-l5"><a class="reference internal" href="#bootstrap">Bootstrap</a></li>
<li class="toctree-l5"><a class="reference internal" href="#json-lookup">JSON Lookup</a></li>
<li class="toctree-l5"><a class="reference internal" href="#adding-your-own-scripts">Adding your own Scripts</a></li>
<li class="toctree-l5"><a class="reference internal" href="#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#resource-types">Resource types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">Monitoring and Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bcp/index.html">Business Continuity Plan (BCP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest/index.html">Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation.html">Under the Hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javadocs/index.html">Javadocs</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="chef-solo-automator-plugin.html"
                        title="Previous Chapter">Chef Solo Automator Plugin</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="monitoring.html"
                        title="Next Chapter">Monitoring and Metrics</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="monitoring.html" title="Monitoring and Metrics"
             >Next</a> |</li>
        <li class="right" >
          <a href="chef-solo-automator-plugin.html" title="Chef Solo Automator Plugin"
             >Previous</a> |</li>
        <li><a href="../../index.html">Coopr 0.9.8 Beta Documentation</a> &raquo;</li>
          <li><a href="index.html" >Super Admin Guide</a> &raquo;</li>
          <li><a href="plugins.html" >Provisioner Plugins</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        Copyright &copy; 2014 Cask Data, Inc.
    </div>
  </body>
</html>